<?php
/**
 * Created by PhpStorm.
 * User: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
 * Date: 23.03.2021
 * Time: 16:43
 */

require_once(__DIR__ . '/../vendor/autoload.php');

use app\models\KpcentrObor;
use app\models\KpcentrPokazn;
use Viber\Bot;
use Viber\Api\Sender;
use Monolog\Logger;
use Monolog\Handler\StreamHandler;
use app\models\UtKart;
use app\poslug\models\UtAbonent;
use app\poslug\models\UtAbonkart;
use app\poslug\models\UtObor;
use app\poslug\models\UtOpl;


function getKpMenu(){

    return (new \Viber\Api\Keyboard())
        ->setButtons([
            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                //->setBgColor('#8074d6')
                // ->setTextSize('small')
                ->setTextSize('small')
                ->setTextHAlign('center')
                ->setTextVAlign('center')
                ->setActionType('reply')
                ->setActionBody('Infomenu-button')
                ->setBgColor("#75C5F3")
                ->setText('üìà  –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø–æ –æ—Å.—Ä–∞—Ö—É–Ω–∫–∞—Ö'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('small')
                ->setActionType('reply')
                ->setActionBody('Pokazmenu-button')
                ->setBgColor("#75C5F3")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('üìü  –ü–æ–¥–∞—Ç–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('small')
                ->setActionType('reply')
                ->setActionBody('Rahmenu-button')
                ->setBgColor("#75C5F3")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('‚ôª  –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –æ—Å.—Ä–∞—Ö—É–Ω–∫–∞–º–∏'),


            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('large')
                ->setActionType('reply')
                ->setActionBody('Kontakt-button')
                // ->setBgColor("#F3DD27")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                ->setActionType('open-url')
                ->setActionBody('https://next.privat24.ua/payments/form/%7B%22companyID%22:%222381919%22,%22form%22:%7B%22query%22:%2233006271%22%7D%7D')
                ->setImage("https://dmkg.com.ua/uploads/privat800x200.png"),
        ]);

}

function getDmkgMenu(){

    return (new \Viber\Api\Keyboard())
        ->setButtons([
            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //->setBgColor('#8074d6')
                // ->setTextSize('small')
                ->setTextSize('small')
                ->setTextHAlign('center')
                ->setTextVAlign('center')
                ->setActionType('reply')
                ->setActionBody('Infomenu-button')
                ->setBgColor("#F2F3A7")
                ->setText('üìä  –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø–æ —Ä–∞—Ö—É–Ω–∫–∞—Ö'),

//            (new \Viber\Api\Keyboard\Button())
//                ->setColumns(2)
//                //  ->setBgColor('#2fa4e7')
//                ->setTextHAlign('center')
//                ->setTextSize('small')
//                ->setActionType('reply')
//                ->setActionBody('Pokazmenu-button')
//                ->setBgColor("#75C5F3")
//                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
//                ->setText('üìü  –ü–æ–¥–∞—Ç–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('small')
                ->setActionType('reply')
                ->setActionBody('Rahmenu-button')
                ->setBgColor("#F2F3A7")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('‚öô –î–æ–¥–∞—Ç–∏/–≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫'),


            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('large')
                ->setActionType('reply')
                ->setActionBody('Kontakt-button')
                // ->setBgColor("#F3DD27")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('üì¨ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                ->setActionType('open-url')
                ->setActionBody('https://next.privat24.ua/payments/form/%7B%22companyID%22:%222383219%22,%22form%22:%7B%22query%22:%2236188893%22%7D%7D')
                ->setImage("https://dmkg.com.ua/uploads/privat800x200.png"),
        ]);

}

function getMyMenu(){

    return (new \Viber\Api\Keyboard())
        ->setButtons([
            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //->setBgColor('#8074d6')
                // ->setTextSize('small')
                ->setTextSize('small')
                ->setTextHAlign('center')
                ->setTextVAlign('center')
                ->setActionType('reply')
                ->setActionBody('Infomenu-button')
                ->setBgColor("#F2F3A7")
                ->setText('üìä  –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø–æ —Ä–∞—Ö—É–Ω–∫–∞—Ö111'),

//            (new \Viber\Api\Keyboard\Button())
//                ->setColumns(2)
//                //  ->setBgColor('#2fa4e7')
//                ->setTextHAlign('center')
//                ->setTextSize('small')
//                ->setActionType('reply')
//                ->setActionBody('Pokazmenu-button')
//                ->setBgColor("#75C5F3")
//                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
//                ->setText('üìü  –ü–æ–¥–∞—Ç–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(3)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('small')
                ->setActionType('reply')
                ->setActionBody('Rahmenu-button')
                ->setBgColor("#F2F3A7")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('‚öô –î–æ–¥–∞—Ç–∏/–≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫'),


            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('large')
                ->setActionType('reply')
                ->setActionBody('Kontakt-button')
                // ->setBgColor("#F3DD27")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('üì¨ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è'),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                ->setActionType('open-url')
                ->setActionBody('https://next.privat24.ua/payments/form/%7B%22companyID%22:%222383219%22,%22form%22:%7B%22query%22:%2236188893%22%7D%7D')
                ->setImage("https://dmkg.com.ua/uploads/privat800x200.png"),

            (new \Viber\Api\Keyboard\Button())
                ->setColumns(2)
                //  ->setBgColor('#2fa4e7')
                ->setTextHAlign('center')
                ->setTextSize('large')
                ->setActionType('reply')
                ->setActionBody('Kontakt-button')
                // ->setBgColor("#F3DD27")
                // ->setImage("https://dmkg.com.ua/uploads/copy.png")
                ->setText('üì¨ –í–∏—Ö—ñ–¥'),
        ]);

}

function infoDmkgSchet($schet){

    $mess='';
    $modelKart = UtKart::findOne(['schet' => $schet]);
    $mess = '–û—Å–æ–±–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫ - '.$schet."\r\n";
    $mess = $mess.$modelKart->fio . "\n";
    $mess = $mess.$modelKart->getUlica()->asArray()->one()['ul'].' –±—É–¥.'.$modelKart->dom.' '.(isset($modelKart->kv)?'–∫–≤.'.$modelKart->kv:'')."\r\n";
    $mess = $mess.'----------------------------'."\n";

    $abonen = UtAbonent::find()->where(['schet' => $schet])->orderBy('id_org')->one();
    $oplab=UtOpl::find()
        ->select('ut_opl.id_abonent, ut_opl.id_posl, sum(ut_opl.sum) as summ')
        ->where(['ut_opl.id_abonent'=> $abonen->id])
        ->andwhere(['>', 'ut_opl.period', $modelKart->lastperiod()])
        ->groupBy('ut_opl.id_abonent, ut_opl.id_posl')
        ->asArray();

    $dolg= UtObor::find();
//					->select(["ut_obor.id_abonent as id", "ut_obor.period", "ut_obor.id_posl","ut_obor.sal","b.summ","round((ut_obor.sal-COALESCE(b.summ,0)),2) as dolgopl"])
    $dolg->select(["ut_obor.id_abonent as id", "ut_obor.*","round(COALESCE(b.summ,0),2) summ","round((ut_obor.sal-COALESCE(b.summ,0)),2) as dolgopl"]);
//  				    $dolg->select('ut_obor.*,b.summ,');
    $dolg->where(['ut_obor.id_abonent'=> $abonen->id,'ut_obor.period'=> $modelKart->lastperiod()]);
    $dolg->leftJoin(['b' => $oplab], '`b`.`id_abonent` = ut_obor.`id_abonent` and `b`.`id_posl`=`ut_obor`.`id_posl`')->all();
    $mess = $mess.'–í–∞—à–∞ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –ø–æ—Å–ª—É–≥–∞–º:'."\n\r";
    $summa =0;
    foreach($dolg->asArray()->all() as $obb)
    {
        $mess = $mess.$obb['tipposl'].' '.$obb['sal']."\n";

        if ($obb['dolgopl']>0)
        {
            $summa = $summa + $obb['dolgopl'];
        }
    }
    $mess = $mess.'----------------------------'."\n";

    $mess = $mess."\r".'–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏: '.$summa."\n";


    return $mess;

}

function infoKpSchet($schet){

    $mess='';
    $modelObor = KpcentrObor::findOne(['schet' => $schet,'status' => 1]);
    $mess = '–û—Å–æ–±–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫ - '.$schet."\n";
    $mess = $mess.$modelObor->fio .' '.$modelObor->im.' '.$modelObor->ot. "\n";
    $mess = $mess.$modelObor->ulnaim.' –±—É–¥.'.$modelObor->nomdom.' '.(isset($modelObor->nomkv)?'–∫–≤.'.$modelObor->nomkv:'')."\n";

    $dolg= KpcentrObor::find();
//					->select(["ut_obor.id_abonent as id", "ut_obor.period", "ut_obor.id_posl","ut_obor.sal","b.summ","round((ut_obor.sal-COALESCE(b.summ,0)),2) as dolgopl"])
    $dolg->select(["kpcentr_obor.*"]);
//  				    $dolg->select('ut_obor.*,b.summ,');
    $dolg->where(['kpcentr_obor.schet'=> $schet,'status' => 1])->all();
    $mess = $mess.'----------------------------'."\n";


    $summa =0;
    foreach($dolg->asArray()->all() as $obb)
    {
        if ($obb['sal']>=0) $mess = $mess.'–í–∞—à–∞ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω—ñ—Å—Ç—å –ø–æ –ø–æ—Å–ª—É–∑—ñ:'."\n";
        else $mess = $mess.'–í–∞—à–∞ –ø–µ—Ä–µ–¥–ø–ª–∞—Ç–∞ –ø–æ –ø–æ—Å–ª—É–∑—ñ:'."\n";
        $mess = $mess.$obb['naim_wid'].': '.$obb['sal']."–≥—Ä–Ω \n";

        if ($obb['sal']>0)
        {
            $summa = $summa + $obb['sal'];
        }
    }


    // $mess = $mess."\r".'–í—Å—å–æ–≥–æ –¥–æ —Å–ø–ª–∞—Ç–∏: '.$summa."\n\r";
    $mess = $mess.'----------------------------'."\n";
    $modelPokazn = KpcentrPokazn::findOne(['schet' => $schet,'status' => 1]);
    if ($modelPokazn!=null){
        $mess = $mess.'–û—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ –ø–æ –≤–æ–¥—ñ :'."\n";
        $mess = $mess."–î–∞—Ç–∞ –ø–æ–∫–∞–∑–Ω–∏–∫–∞: ".date('d.m.Y',strtotime($modelPokazn->date_pok))."\n";
        $mess = $mess.'–ü–æ–∫–∞–∑–Ω–∏–∫: '.$modelPokazn->pokazn."\n";
    }




    return $mess;

}